\chapter{Proposed Method}
\label{sec:proposed}
In this section, the discussion centers on the proposed method which improves the problems described in Sec.\ref{sec:problems}.
First, a mixture $L_{2}$ - $L_{p}$ variational retinex model which further considers the feature of the reflectance and illumination is introduced in Sec. \ref{sec:L2-LP}. 
Next, an adaptive texture map which selectively constrain noise amplification in dark regions and over-enhancement in bright regions is described in Sec. \ref{sec:adaptive}. 
Finally, the solution of the proposed minimization optimization equation is mentioned in Sec. \ref{sec:solution}.\par
Fig. \ref{fig:proposed/flowchart} shows the flowchart of the proposed method.
To explain the flow of the proposed method briefly, the proposed method obtains a low-light image and an initialized illumination which is called the bright channel prior. Next, the proposed method converses a low-light image to HSV-Color scale and extract only value (V) channel. The proposed method iteratively solves sub-problems related with the reflectance and illumination and gets their component which meet the constraints are appropriate for each component. Finally, the proposed method multiply the estimated reflectance and illumination, converses the obtained enhanced image to RGB-Color space.

%----提案手法のフローチャート---- %
\begin{figure}[tb]
	\centering
	\includegraphics[width=1.0\hsize]{images/proposed/flowchart.eps}
	\caption{The image represents the flowchart of the proposed method. (i)The proposed method changes the constraint terms further considered the characteristics for each component. (ii)The proposed method generates adaptive texture map to constrain noise  amplification and over-enhancement in the estimated reflectance. } \label{fig:proposed/flowchart}
\end{figure}

\section{Mixture L2-LP Variational Model} \label{sec:L2-LP}
The conventional methods adopt a $L_{1}$ norm to the constraint term on the reflectance, but the fine detail of the estimated reflectance are susceptible to be damaged. Furthermore, by adopting a $L_{2}$ norm to the constraint term on the illumination, the estimated illumination over-smooths and loss the structure information. Therefore, the proposed method adopts $L_{2}$ - $L_{P}$ norm regularization to each constraint term in order to estimate the reflectance as much as possible to preserve fine detail and estimate the illumination as much as possible to keep the structure information while removing texture component.
The new joint optimization equation is given as:
\begin{equation}
E(I, R) = \argmin_{R, I} \|R \circ I - S\|_{2}^{2} + \alpha \left \|\frac{\nabla{I}}{\frac{1}{\Omega}\Sigma_{\Omega}\nabla{I}+\epsilon}\right\|_{p}^{p} + \beta \|W \circ \nabla{R}\|_{2}^{2} + \gamma \|I - B\|_{2}^{2}, \label{eq:proposed/equation}
\end{equation}
where $\| \cdot \|_{p}$ denotes the $L_{p}$ norm regularization term $(0 < p \leq 2)$, and $W$ is the adaptive texture map related to the reflectance $R$.\par
As described in \cite{l2-lp}, a block coordinate descent \cite{block} is used in order to find an optimal solution to the non-convex objective function $(\ref{eq:proposed/equation})$. Since the $L_{p}$ regularization term causes non-smooth optimization, the proposed method adopts an iteratively re-weighted least square (IRLS) method \cite{iterate} and rewrite the second term in $(\ref{eq:proposed/equation})$ as:
\begin{equation}
\left \|\frac{\nabla{I}}{\frac{1}{\Omega}\Sigma_{\Omega}\nabla{I}+\epsilon}\right\|^{p} = \|U \circ \nabla{I}\|^{2}, \label{eq:approximation}
\end{equation}

\begin{align}
U &= \left \{
	\begin{array}{ll}
	\frac{1}{\xi^{2-p}}, 
	& \left |\frac{\nabla{I}}{\frac{1}{|\Omega|} \sum_{\Omega} \nabla{I} } \right| < \xi\\
	\frac{\left |\Sigma_{\Omega} \nabla{I} \right|^{2-p}}{\left |\nabla{I} \right|^{2-p}} \frac{1}{\left |\Sigma_{\Omega} \nabla{I} \right|^{2}},
	& \rm{otherwise}
	\end{array}
\right.\\
  &= \left \{
  	\begin{array}{ll}
  	\frac{1}{\xi^{2-p}}, 
  	& \left |\frac{\nabla{I}}{\frac{1}{|\Omega|} \sum_{\Omega} \nabla{I} } \right| < \xi\\
  	\frac{1}{\left |\Sigma_{\Omega} \nabla{I} \right|^{p} \left |\nabla{I} \right|^{2-p}},
  	& \rm{otherwise}
  	\end{array}
\right. \label{eq:lp_shape}
\end{align}
where the variable $u$ is only approximate variable. This is because the Eq. \ref{eq:approximation} uses a $L_{2}$ norm format $\Phi(\frac{\nabla{I}}{\frac{1}{\Omega}\Sigma_{\Omega}\nabla{I}+\epsilon};\xi)$ based on \cite{l0-sparse} to approximate the $L_{0} $ norm function. As can be seen in Fig. \ref{fig:nom_p/comparison}, the red curve can approximate the most sparse $L_{0}$ function. Therefore, the proposed method can remove fine textures detail and preserve meaningful salient structures in the estimated illumination. As shown in Fig. \ref{fig:nom_p/graph_norm_p}, with the decease of the value $\xi$, the $L_{p}$ norm function is getting close to the $L_{0}$ function. Therefore, large-$\xi$ are more convex-like and easy to optimize, in contrast, small-$\xi$ are more steep and difficult to optimize.\par
Fig. \ref{fig:comparison_p} shows the effect of changing the value of $p$ in the range ($0 < p \leq 2$) in the estimated illumination. As the value of $p$ decreases, the estimated illumination leaves smooth and texture-less. Concomitantly, the estimated reflectance contains more rich textures detail. In particular, when $p=0$, some salient structure information in the estimated illumination may be lost too much, because the $L_{0}$ norm has strong sparsity. 
%----Lpノルムの概形----
\begin{figure}[tb]
\vspace{-15pt}
	\begin{minipage}[b]{0.5\hsize}
		\centering
		\includegraphics[width=72mm, height = 54mm]{images/norm_p/graph/graph_norm.eps}
		\subcaption{Plots of different penalty functions} \label{fig:nom_p/comparison}
	\end{minipage}
	\begin{minipage}[b]{0.5\hsize}
		\centering
		\includegraphics[width=72mm, height = 54mm]{images/norm_p/graph/graph_norm_p.eps}
		\subcaption{Plots of $L_{p}$ norm for different values $p$} \label{fig:nom_p/graph_norm_p}
	\end{minipage}
	\caption{The images represent various plots about the $L_{p}$ norm, when $p \approx 0$.}
	\label{fig:graph_lp}
\end{figure}
%----ノルムpによる推定比較---- %
\begin{figure*}[tb]
\centering
	\begin{minipage}[b]{0.32\hsize}
	\centering
	\includegraphics[width=49mm, height = 49mm]{images/norm_p/reflectance/p06.eps}
	\end{minipage}
	\begin{minipage}[b]{0.32\hsize}
	\centering
	\includegraphics[width=49mm, height = 49mm]{images/norm_p/reflectance/p10.eps}
	\end{minipage}
	\begin{minipage}[b]{0.32\hsize}
	\centering
	\includegraphics[width=49mm, height = 49mm]{images/norm_p/reflectance/p20.eps}
	\end{minipage}\\
	\vspace{1.5mm}
	\begin{minipage}[b]{0.32\hsize}
	\centering
	\includegraphics[width=49mm, height = 49mm]{images/norm_p/illumination/p06.eps}
	\subcaption{$p$=0.6} \label{fig. p-04}
	\end{minipage}
	\begin{minipage}[b]{0.32\hsize}
	\centering
	\includegraphics[width=49mm, height = 49mm]{images/norm_p/illumination/p10.eps}
	\subcaption{$p$=1.0} \label{fig. p-10}
	\end{minipage}
	\begin{minipage}[b]{0.32\hsize}
	\centering
	\includegraphics[width=49mm, height = 49mm]{images/norm_p/illumination/p20.eps}
	\subcaption{$p$=2.0} \label{fig. p-20}
	\end{minipage}
	\caption{Comparison of decomposition results for different values of norm $p$. ((a)-(c) top: reflectance, bottom: illumination)}
	\label{fig:comparison_p}
\end{figure*}

\section{Adaptive Texture Map} \label{sec:adaptive}
The discussion centers on the effect of the adaptive texture map using as the weight of the constraint term on the reflectance. Discussed in Sec. \ref{sec:retinex}, reflectance component contains rich details. However, when a low-light image is enhanced, noise hidden in dark regions amplifies and over-enhancement cause in bright regions in the estimated reflectance. Therefore, the weight which controls noise amplification and over-enhancement is necessary for the constraint term on the reflectance. In addition, the preferable reflectance's gradients should be smooth in homogeneous regions while undamaged at edges and texture regions. Thus, when estimating the reflectance, the weight which can recognize more texture regions is required. Fig. \ref{fig:adaptive/classification} shows the summary of the above discussion.
Then, the adaptive texture map $W$ is set so that the third term performs strong noise reduction in dark and homogeneous regions, while it performs weak noise reduction in bright and textures regions. 
The formulation of $W$ is given as:
\begin{equation}
W_{d} = W_{B} \circ A_{d}, \label{eq: adaptive_texture}
\end{equation}
where $d$ represents horizontal ($h$) and vertical ($v$) directions, and $W_{B}$ represents an initial estimated weight map by inverting the normalized bright channel, and $A_{d}$ represents a texture map that effectively distinguish between homogeneous and textures regions.\par
In the same way as in \cite{activation}, given an observed low-light image, $W_{B}$ can selectively assign different values according to BCP since the estimated bright channel contains large values in bright regions and vice versa. 
Thus, $W_{B}$ is given as:
\begin{equation}
W_{B} = 1.0 - \max_{c \in \{r, g, b\}}S^{c}. \label{eq: initial_weight}
\end{equation}
Fig. \ref{fig:adaptive/wb} shows the image of $W_{B}$. Since smaller weight values are assigned in bright regions, $W_{B}$ performs the weaker noise reduction. In contrast, stronger noise reduction is performed in dark regions.\par
 
Moreover, the texture map $A_{d}$ is set as the inverse of the $a_{r}$-th power of the absolute value of a mean local variation (MLV) \cite{jiep}, so that it can significantly distinguish between homogeneous regions and textures regions:
\begin{equation}
A_{d} = \frac{1}{\left |\frac{1}{|\Omega|}\sum_{\Omega}\nabla_{d}{R} \right|^{a_{r}} + \epsilon}, \label{eq: mlv}
\end{equation}
where $a_{r} (< 1)$ is an exponential parameter to adjust the awareness of textures for the reflectance.
As shown in Fig. \ref{fig:mlv_change}, when $a_{r}=1.0$, the texture map $A_{d}$ extracts salient edges but little texture component. In contrast, when $a_{r}=0.5$, it extract both salient edges and rich texture component. Therefore, using the texture map, $W$ performs weaker noise reduction in both edges and texture regions, on the other hand, stronger noise reduction in homogeneous regions.\par
Here, the discussion centers on the effectiveness of the adaptive texture map using Fig. \ref{fig:adaptive/effectiveness}.
As shown in the yellow and green square, the estimated reflectance with $W$ can suppress noise amplification in dark regions and over-enhancement in bright regions more than without $W$. This is because $W_{B}$ can significantly assign different values between dark and bright regions. 
Next, in order to confirm the effectiveness of the texture map $A_{d}$, the edge magnitude in the red square is calculated:
\begin{equation}
M(h, v) = \sqrt{G_{h} ^{2}+ G_{v}^{2}}, \label{eq:maginitude}
\end{equation}
where $G_{h}$, $G_{v}$ represent the horizontal-vertical gradient image respectively. Fig.\ref{fig:adaptive/edge_magnitude} shows the plots of average v-axis edge magnitude. It can be seen the average gradient magnitude with $W$ has larger values and the values fluctuate more rapidly than without $W$. Therefore, the texture map $A_{d}$ contributes to the awareness of textures in the estimated reflectance.
% ----Classificationの図----%
\begin{figure}[tb]
	\centering
	\includegraphics[width=1.0\hsize]{images/adaptive/classification.eps}
	\caption{The image represents the classification of regions where the adaptive texture map has an impact on.} \label{fig:adaptive/classification}
\end{figure}
% ----Weight of BCPの図----%
\begin{figure}[tb]
	\centering
	\includegraphics[width=0.5\hsize]{images/adaptive/wb.eps}
	\caption{The image represents $W_{B}$. $W_{B}$ contains smaller values in bright regions, in contrast, larger values in dark regions.} \label{fig:adaptive/wb}
\end{figure}
% ----Texture Mapの図----%
\begin{figure}[tb]
\centering
\begin{minipage}[b]{0.49\hsize}
\centering
\includegraphics[height=0.65\hsize]{images/noise/MLV_10.eps}
\subcaption{MLV ($a_{r}=1.0$)} \label{fig:mlv_normal}
\end{minipage}
\begin{minipage}[b]{0.49\hsize}
\centering
\includegraphics[height=0.65\hsize]{images/noise/MLV_05.eps}
\subcaption{MLV ($a_{r}=0.5$)} \label{fig:mlv_pow}
\end{minipage}
\caption{Comparison of MLV results for different values of $a_{r}$. As the value of $a_{r}$ decreases, MLV can obtain more rich gradient information.}
\label{fig:mlv_change}
\end{figure}
% ----Texture Mapの抑制図----%
\begin{figure}[tb]
\centering
\begin{minipage}[b]{0.49\hsize}
\centering
\includegraphics[width=60mm, height=60mm]{images/adaptive/without.eps}
\subcaption{Reflectance w/o $W$} \label{fig:wo}
\end{minipage}
\begin{minipage}[b]{0.49\hsize}
\centering
\includegraphics[width=60mm, height=60mm]{images/adaptive/with.eps}
\subcaption{Reflectance with $W$} \label{fig:w}
\end{minipage}
\caption{Comparison of reflectance results. (a) the estimated reflectance without $W$; (b) the estimated reflectance with $W$.}
\label{fig:adaptive/effectiveness}
\end{figure}
% ----Edge Magnitudeの図----%
\begin{figure}[tb]
	\centering
	\includegraphics[width=0.5\hsize]{images/adaptive/graph_edge.eps}
	\caption{The image represents the plots of the average edge magnitude.} \label{fig:adaptive/edge_magnitude}
\end{figure}

\section{Solution} \label{sec:solution}
The minimization optimization problem (\ref{eq:proposed/equation}) can be solved by iteratively updating each component. In particular, for the $k$-th iteration of sub-problems.
\begin{enumerate}
\renewcommand{\labelenumi}{\arabic{enumi}).}
\item \textbf{$\boldmath{I}$ sub-problem:} Collecting the terms related to $I$ leads to the following equation (\ref{eq:proposed/equation}):
\begin{equation}
I_{k} = \argmin_{I}\|R_{k-1} \circ I - S\|_{2}^{2} + \alpha\|U \circ \nabla{I}\|_{2}^{2} 
+\lambda \|I - B\|_{2}^{2}. \label{eq: i_subproblem}
\end{equation}
The equation (\ref{eq: i_subproblem}) is transferred to a classic least square problem:
\begin{equation}
i_{k} = \argmin_{i} \|r_{k-1} i - s\|_{2}^{2} + \alpha\|uDi\|_{2}^{2} + \lambda \|i - b\|_{2}^{2}, \label{eq:classic_i_subproblem}
\end{equation}
where $i$ is the vectorized format of $I$ and $D$ contains $D_{h}$ and $D_{v}$, which are the Toeplitz matrices from the discrete gradient operators with forward difference.
The same notation is used for other matrices (r, s, b corresponds to R, S, and B, respectively). By differentiating equation (\ref{eq:classic_i_subproblem}) with respect to $i$, and setting the derivative to $0$, we have the following solution:
\begin{equation}
i_{k+1} = (r_{k-1}r_{k-1}^{T} + \alpha D^{T}uD + \lambda{1})^{-1} (r_{k-1}^{T}s + \lambda{b}). \label{eq: i_solution}
\end{equation}
Then, the obtained $i_{k}$ is reformulated into matrix format $I_{k}$.
\item \textbf{$R$ sub-problem:} After acquiring $I_{k}$ from the above solution, the joint optimization (\ref{eq:proposed/equation}) related to $R$ becomes similar to that of $I$:
\begin{equation}
R_{k} = \argmin_{R}\|R \circ I_{k} - S\|_{2}^{2} + \beta\|W \circ \nabla{R}\|_{2}^{2}. \label{eq: r_subproblem}
\end{equation}
In the same way as in the former derivation, the solution of $R$ is provided as follows:
\begin{equation}
r_{k} = \argmin_{r} \|ri_{k} - s\|_{2}^{2} + \beta\|wDr\|_{2}^{2}, \label{eq:classic_r_subproblem}
\end{equation}
\begin{equation}
r_{k} = (i_{k}i_{k}^{T} + \beta D^{T}wD)^{-1} (i_{k}^{T}s). \label{eq: solution_r_subproblem}
\end{equation}
Similarly, the obtained $r_{k}$ is reformulated into matrix format $R_{k}$.
\end{enumerate}
The values of $I$ and $R$ are updated until $\|I_{k}-I_{k-1}\|/\|I_{k-1}\| \leq \varepsilon$ and $\|R_{k}-R_{k-1}\|/\|R_{k-1}\| \leq \varepsilon$ are simultaneously satisfied. After the estimation of  the reflectance and illumination, a Gamma correction operation is adopted to adjust the illumination. Therefore, the final enhanced image is given as $ S_{enhanced} = R \circ I^{\frac{1}{\gamma^{'}}}, \label{eq_final}$ where the empirical parameter $\gamma^{'}$ is set as 2.2. To preserve color information, the Gamma correction is performed in the HSV domain.

Fig. \ref{fig:proposed/output} shows the result of the proposed method. The proposed method can estimate the illumination as much as possible to smooth and keep the meaningful structure information while removing much textures detail and estimate the reflectance as much as possible to clarify fine textures detail while suppressing noise amplification in dark regions and over-enhancement in bright regions. Therefore, it can be seen the proposed method naturally enhances low-light images.
%----提案手法の結果の図---- %
\begin{figure}[tb]
\centering
	\begin{minipage}[b]{0.49\hsize}
		\centering
		\includegraphics[width=62.5mm]{images/proposed/input.eps}
		\subcaption{Low-Light Image} \label{fig:proposed/input}
	\end{minipage}
	\begin{minipage}[b]{0.49\hsize}
		\centering
		\includegraphics[width=62.5mm]{images/proposed/illumination.eps}
		\subcaption{Illumination} \label{fig:proposed/illumination}
	\end{minipage}
	\begin{minipage}[b]{0.49\hsize}
		\centering
		\includegraphics[width=62.5mm]{images/proposed/reflectance.eps}
		\subcaption{Reflectance} \label{fig:proposed/reflectance}
	\end{minipage}
	\begin{minipage}[b]{0.49\hsize}
		\centering
		\includegraphics[width=62.5mm]{images/proposed/output.eps}
		\subcaption{Enhanced Image} \label{fig:proposed/enhanced}
	\end{minipage}
	\caption{The images represent the result of the proposed method.}
	\label{fig:proposed/output}
\end{figure}